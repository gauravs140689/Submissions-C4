@page "/"
@using FinSynth.Web.Services
@inject FinancialDataService FinancialData

<PageTitle>Dashboard - FinSynth</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenText TextStyle="TextStyle.H3">Financial Dashboard</RadzenText>
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-text-secondary-color">
                Your financial overview at a glance
            </RadzenText>
        </RadzenColumn>
    </RadzenRow>

    @if (FinancialData.CurrentSnapshot == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
            <RadzenText>No financial data loaded. <RadzenLink Path="/upload">Upload documents</RadzenLink> or <RadzenLink Path="/data">enter data manually</RadzenLink> to get started.</RadzenText>
        </RadzenAlert>

        <RadzenButton Text="Load Sample Data" Icon="science" Click="@LoadSampleData" ButtonStyle="ButtonStyle.Primary" />
    }
    else
    {
        var snapshot = FinancialData.CurrentSnapshot;
        var totalIncome = snapshot.Incomes.Sum(i => i.MonthlyAmount);
        var totalExpenses = snapshot.Expenses.Sum(e => e.MonthlyAmount);
        var totalDebt = snapshot.Debts.Sum(d => d.Balance);
        var totalDebtPayments = snapshot.Debts.Sum(d => d.MinimumPayment);
        var netCashFlow = totalIncome - totalExpenses;

        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard class="rz-shadow-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenIcon Icon="trending_up" Style="font-size: 3rem; color: var(--rz-success);" />
                        <RadzenStack Gap="0">
                            <RadzenText TextStyle="TextStyle.Overline" class="rz-text-secondary-color">Monthly Income</RadzenText>
                            <RadzenText TextStyle="TextStyle.H4" class="rz-color-success">${totalIncome:N2}</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">@snapshot.Incomes.Count source(s)</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard class="rz-shadow-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenIcon Icon="trending_down" Style="font-size: 3rem; color: var(--rz-danger);" />
                        <RadzenStack Gap="0">
                            <RadzenText TextStyle="TextStyle.Overline" class="rz-text-secondary-color">Monthly Expenses</RadzenText>
                            <RadzenText TextStyle="TextStyle.H4" class="rz-color-danger">${totalExpenses:N2}</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">@snapshot.Expenses.Count category(s)</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard class="rz-shadow-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenIcon Icon="credit_card" Style="font-size: 3rem; color: var(--rz-warning);" />
                        <RadzenStack Gap="0">
                            <RadzenText TextStyle="TextStyle.Overline" class="rz-text-secondary-color">Total Debt</RadzenText>
                            <RadzenText TextStyle="TextStyle.H4" class="rz-color-warning">${totalDebt:N2}</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">@snapshot.Debts.Count account(s)</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard class="rz-shadow-3">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenIcon Icon="account_balance" Style="font-size: 3rem; color: var(--rz-info);" />
                        <RadzenStack Gap="0">
                            <RadzenText TextStyle="TextStyle.Overline" class="rz-text-secondary-color">Net Cash Flow</RadzenText>
                            <RadzenText TextStyle="TextStyle.H4" Class="@(netCashFlow >= 0 ? "rz-color-success" : "rz-color-danger")">${netCashFlow:N2}</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">@(totalIncome > 0 ? $"{(netCashFlow / totalIncome):P0} of income" : "N/A")</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard class="rz-shadow-3">
                    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Income Breakdown</RadzenText>
                    <RadzenChart>
                        <RadzenDonutSeries Data="@snapshot.Incomes" CategoryProperty="Source" ValueProperty="MonthlyAmount"
                                           Title="Income Sources" Fills="@(new[] { "#28a745", "#20c997" })">
                            <RadzenSeriesDataLabels Visible="true" />
                        </RadzenDonutSeries>
                    </RadzenChart>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard class="rz-shadow-3">
                    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Expense Breakdown</RadzenText>
                    <RadzenChart>
                        <RadzenDonutSeries Data="@snapshot.Expenses" CategoryProperty="Category" ValueProperty="MonthlyAmount"
                                           Title="Expenses" Fills="@(new[] { "#dc3545", "#fd7e14", "#ffc107", "#17a2b8", "#6f42c1" })">
                            <RadzenSeriesDataLabels Visible="true" />
                        </RadzenDonutSeries>
                    </RadzenChart>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12">
                <RadzenCard class="rz-shadow-3">
                    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Debt Accounts</RadzenText>
                    <RadzenDataGrid Data="@snapshot.Debts" TItem="FinSynth.Core.Models.DebtAccount" AllowSorting="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="FinSynth.Core.Models.DebtAccount" Property="AccountName" Title="Account" />
                            <RadzenDataGridColumn TItem="FinSynth.Core.Models.DebtAccount" Property="Balance" Title="Balance" FormatString="{0:C}" />
                            <RadzenDataGridColumn TItem="FinSynth.Core.Models.DebtAccount" Property="InterestRate" Title="APR" FormatString="{0:0.00}%" />
                            <RadzenDataGridColumn TItem="FinSynth.Core.Models.DebtAccount" Property="MinimumPayment" Title="Min Payment" FormatString="{0:C}" />
                            <RadzenDataGridColumn TItem="FinSynth.Core.Models.DebtAccount" Property="AccountType" Title="Type" />
                        </Columns>
                    </RadzenDataGrid>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    protected override void OnInitialized()
    {
        FinancialData.OnSnapshotChanged += StateHasChanged;
    }

    private void LoadSampleData()
    {
        FinancialData.InitializeWithSampleData();
    }

    public void Dispose()
    {
        FinancialData.OnSnapshotChanged -= StateHasChanged;
    }
}
