@page "/chat"
@using FinSynth.Web.Services
@inject ChatService ChatService
@inject FinancialDataService FinancialData

<PageTitle>Agent Chat - FinSynth</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenText TextStyle="TextStyle.H3">Multi-Agent Financial Advisor</RadzenText>
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-text-secondary-color">
                Ask questions and get expert advice from specialized AI agents
            </RadzenText>
        </RadzenColumn>
    </RadzenRow>

    @if (FinancialData.CurrentSnapshot == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat">
            <RadzenText>No financial data loaded. Agents work best with your financial data. <RadzenLink Path="/data">Add data</RadzenLink> to get personalized advice.</RadzenText>
        </RadzenAlert>
    }

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard class="rz-shadow-3" Style="height: 600px; display: flex; flex-direction: column;">
                <div style="flex: 1; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    @if (!ChatService.Messages.Any())
                    {
                        <RadzenStack Gap="1rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 100%;">
                            <RadzenIcon Icon="chat_bubble_outline" Style="font-size: 4rem; color: #ccc;" />
                            <RadzenText TextStyle="TextStyle.H6" class="rz-text-secondary-color">Start a conversation</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-text-secondary-color">
                                Ask about debt reduction, savings strategies, or budget optimization
                            </RadzenText>
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenStack Gap="1rem">
                            @foreach (var message in ChatService.Messages)
                            {
                                <div class="chat-message @(message.Role == "user" ? "user-message" : "agent-message")">
                                    <RadzenStack Gap="0.5rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            @if (message.Role == "user")
                                            {
                                                <RadzenIcon Icon="person" Style="color: var(--rz-primary);" />
                                                <RadzenText TextStyle="TextStyle.Subtitle2">You</RadzenText>
                                            }
                                            else
                                            {
                                                <RadzenIcon Icon="smart_toy" Style="color: var(--rz-success);" />
                                                <RadzenText TextStyle="TextStyle.Subtitle2">
                                                    @GetAgentName(message.AgentId)
                                                    @if (message.Confidence.HasValue)
                                                    {
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@($"{message.Confidence.Value:P0}")" class="rz-ml-2" />
                                                    }
                                                </RadzenText>
                                            }
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                                                @message.Timestamp.ToString("h:mm tt")
                                            </RadzenText>
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Body1" Style="white-space: pre-wrap;">@message.Content</RadzenText>
                                    </RadzenStack>
                                </div>
                            }
                            <div @ref="messagesEndRef"></div>
                        </RadzenStack>
                    }
                </div>

                <div style="padding-top: 1rem; border-top: 1px solid #dee2e6;">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenTextBox @bind-Value="@userInput" 
                                      Placeholder="Ask about your finances..." 
                                      Style="flex: 1;"
                                      @onkeypress="@(e => { if (e.Key == "Enter" && !isSending) SendMessage(); })"
                                      Disabled="@isSending" />
                        <RadzenButton Text="Send" 
                                     Icon="send" 
                                     Click="@SendMessage" 
                                     Disabled="@(string.IsNullOrWhiteSpace(userInput) || isSending)"
                                     ButtonStyle="ButtonStyle.Primary" />
                    </RadzenStack>
                    @if (isSending)
                    {
                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" class="rz-mt-2" />
                    }
                </div>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard class="rz-shadow-3">
                <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Available Agents</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="ðŸ’³ Debt Analyzer" Style="padding: 0.5rem 1rem;" />
                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="ðŸ’° Savings Strategy" Style="padding: 0.5rem 1rem;" />
                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="ðŸ“Š Budget Advisor" Style="padding: 0.5rem 1rem;" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

<style>
    .chat-message {
        padding: 1rem;
        border-radius: 8px;
        max-width: 80%;
    }

    .user-message {
        background: #e3f2fd;
        margin-left: auto;
        margin-right: 0;
    }

    .agent-message {
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

@code {
    private string userInput = string.Empty;
    private bool isSending;
    private ElementReference messagesEndRef;

    protected override void OnInitialized()
    {
        ChatService.OnMessagesChanged += StateHasChanged;
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isSending) return;

        isSending = true;
        var message = userInput;
        userInput = string.Empty;
        StateHasChanged();

        try
        {
            await ChatService.SendMessageAsync(message);
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    private string GetAgentName(string? agentId)
    {
        return agentId switch
        {
            "debt-analyzer" => "Debt Analyzer",
            "savings-strategy" => "Savings Strategy",
            "budget-advisor" => "Budget Advisor",
            "coordinator" => "Multi-Agent Coordinator",
            _ => "Financial Advisor"
        };
    }

    public void Dispose()
    {
        ChatService.OnMessagesChanged -= StateHasChanged;
    }
}
